"use strict";function showFPS(a){$("#fps-counter").text(a.fps),benchmarking&&results.push(a.fps)}function scenario(){benchmarking=!0;var a=[clickMission,openMissionMenu,closeMissionMenu,goBackHome],b=0,c=30,d=function(){return console.log("doBench"),results.length>=c?(submitResults(),void 0):(b>=a.length&&(b=0),a[b](),b++,setTimeout(d,1e3),void 0)};setTimeout(d,1e3)}function clickMission(){console.log("clickMission");var a=$("#missions-table>tbody>tr:first-child>td:first-child")[0];console.log(a),triggerEvent("tap",a)}function openMissionMenu(){var a=$(".menu-button")[0];triggerEvent("tap",a)}function closeMissionMenu(){var a=$(".menu-button")[0];triggerEvent("tap",a)}function goBackHome(){$(".brand").click()}function submitResults(){benchmarking=!1,$("#fps-counter").css("background-color","black");var a={results:results.toString(),numberOfValues:results.length};$.post("http://192.168.100.51:2403/bench-results",a),results=[]}function triggerEvent(a,b){var c;document.createEvent?(c=document.createEvent("HTMLEvents"),c.initEvent(a,!0,!0)):(c=document.createEventObject(),c.eventType=a),c.eventName=a,c.memo={},document.createEvent?b.dispatchEvent(c):b.fireEvent("on"+c.eventType,c)}angular.module("mobileAngular",["ngResource","$strap.directives","angular-gestures"]),angular.module("mobileAngular").config(["$routeProvider",function(a){a.when("/",{templateUrl:"partials/missions.html",controller:"MissionsController"}),a.when("/mission/new",{templateUrl:"partials/missions/new.html",controller:"NewMissionController"}),a.when("/mission/:missionId",{templateUrl:"partials/mission-container.html",controller:"MissionContainerController",reloadOnSearch:!1}),a.when("/mission/:missionId/events/new",{templateUrl:"partials/mission/events/form.html",controller:"EditEventController"}),a.when("/mission/:missionId/event/:eventId/edit",{templateUrl:"partials/mission/events/form.html",controller:"EditEventController"}),a.when("/mission/:missionId/staff/new",{templateUrl:"partials/mission/staff/new.html",controller:"NewStaffController"}),a.when("/mission/:missionId/vehicle/new",{templateUrl:"partials/mission/vehicles/new.html",controller:"NewVehicleController"}),a.when("/storagemanagement",{templateUrl:"partials/misc/configuration.html",controller:"StorageManagementController"}),a.when("/accelerometer",{templateUrl:"partials/misc/accelerometer.html",controller:"AccelerometerController"}),a.when("/gestures",{templateUrl:"partials/misc/gestures.html",controller:"GesturesController"}),a.when("/commands/",{templateUrl:"partials/misc/command-list.html",controller:"CommandController"}),a.when("/cube/",{templateUrl:"partials/misc/cube.html"}),a.when("/launch",{templateUrl:"partials/launch.html"}),a.when("/init",{templateUrl:"partials/init.html",controller:"BootstrapController"}),a.otherwise({redirectTo:"/"})}]),angular.module("mobileAngular").value("$strap.config",{datepicker:{format:"dd/mm/yyyy"}}),angular.module("mobileAngular").run(["$rootScope","$window","$timeout","DeviceType",function(a,b){a.scrollX=b.scrollX,angular.element(b).bind("scroll",function(){a.scrollX=b.scrollX,a.$apply("scrollX")}),angular.element(b).bind("deviceorientation",function(b){a.orientationData=b,a.$apply("orientationData")})}]),angular.module("mobileAngular").controller("AccelerometerController",["$scope","$rootScope",function(a,b){b.$watch("orientationData",function(b){a.orientationData=b.originalEvent})}]),angular.module("mobileAngular").controller("BootstrapController",["$scope","$rootScope","$http","ClientID","Backend","localStorage","Command","Vehicle","Staff","$window","StoreProvider","CommandUtils",function(a,b,c,d,e,f,g,h,i,j,k,l){a.progress=0,a.$watch("progress",function(b){b>=100&&(a.ready=!0)}),a.save=function(){a.progress=0,a.alerts=[],d.set(a.clientID),e.set(a.backend),a.progress+=10,c.get(a.backend+"/persons").success(function(b){var c=0;i.clear().then(function(){var d=function(b,c){var e=c[b],f={firstname:e.firstname,lastname:e.lastname,"function":{store:"function",id:e.function}};i.save(f).then(function(){b++,b<c.length?d(b,c):a.progress+=30})};d(c,b)})}).error(function(){a.alerts.push({type:"error",title:"Impossible de récupérer les données. Vérifiez que l'adresse du serveur est bonne et qu'il est lancé"})}),c.get(a.backend+"/vehicles").success(function(b){var c=0;h.clear().then(function(){var d=function(b,c){var e=c[b],f={name:e.name,type:e.type};h.save(f).then(function(){b++,b<c.length?d(b,c):a.progress+=30})};d(c,b)})}).error(function(){a.alerts.push({type:"error",title:"Impossible de récupérer les données. Vérifiez que l'adresse du serveur est bonne et qu'il est lancé"})}),c.get(a.backend+"/commands"+'?{"$sort": {"date": 1}}').success(function(b){if(b.length<=0)return a.progress=100,void 0;var c=30/b.length,d=function(b,e){if(b>=e.length)return a.progress=100,void 0;var f=e[b];l.handleCommand(f,function(){a.progress+=c,d(++b,e)},!1,"read")};d(0,b)})},a.continue=function(){f.setItem("SMUR_BOOSTRAPED",!0),j.location.reload()}}]),angular.module("mobileAngular").controller("CommandController",["$scope","Command",function(a,b){a.commands=[],b.getAllSorted().then(function(b){console.log(b),a.commands=b})}]),angular.module("mobileAngular").controller("StorageManagementController",["$scope","$http","Mission","Staff","Event","Vehicle","FileSystem","FileSystemUtils","persistentStorage","Command","localStorage","ClientID","Backend","FullscreenSetting",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){a.alerts=[],a.getStorageStats=function(){i?i.queryUsageAndQuota(function(b,c){a.fs={},a.fs.used=b,a.fs.total=c,a.fs.perc=100*(b/c)}):a.fsPolyfill=!0},a.getStorageStats(),a.clientId=l.get(),a.backend=m.get(),a.fullscreenEnabled=n.get(),a.clearMission=function(){c.clear().then(function(){a.alerts.push({type:"success",title:"Mission cleared"})})},a.clearStaff=function(){d.clear().then(function(){a.alerts.push({type:"success",title:"Staff cleared"})})},a.clearEvent=function(){e.clear().then(function(){a.alerts.push({type:"success",title:"Event cleared"})})},a.clearVehicle=function(){f.clear().then(function(){a.alerts.push({type:"success",title:"Vehicle cleared"})})},a.clearCommand=function(){j.clear().then(function(){a.alerts.push({type:"success",title:"Command cleared"})})},a.populateStaff=function(){b.get(m.get()+"/persons").success(function(b){var c=0;d.clear().then(function(){var e=function(b,c){var f=c[b],g={firstname:f.firstname,lastname:f.lastname,"function":{store:"function",id:f.function}};d.save(g).then(function(){b++,b<c.length?e(b,c):a.alerts.push({type:"success",title:"Personnes ajoutées"})})};e(c,b)})})},a.populateVehicle=function(){b.get(m.get()+"/vehicles").success(function(b){var c=0;f.clear().then(function(){var d=function(b,c){var e=c[b],g={name:e.name,type:e.type};f.save(g).then(function(){b++,b<c.length?d(b,c):a.alerts.push({type:"success",title:"Véhicules ajoutés"})})};d(c,b)})})},a.clearFS=function(){g.getFileSystem().then(function(b){var c=b.root.createReader(),d=[],e=function(){c.readEntries(function(b){b.length?(d=d.concat(Array.prototype.slice.call(b||[],0)),d.forEach(function(b){b.isFile?b.remove(a.getStorageStats,h.errorHandler):b.removeRecursively(a.getStorageStats,h.errorHandler)})):listResults(d.sort())},h.errorHandler)};e()})},a.resetLastCmd=function(){k.setItem("LAST_CMD",0),a.alerts.push({type:"success",title:"ID de la dernière commande reçue remis à zéro."})},a.setClientId=function(){l.set(a.clientId),a.alerts.push({type:"success",title:"Client ID changé."})},a.setClientId=function(){m.set(a.backend),a.alerts.push({type:"success",title:"Backend changé."})},a.setFullscreenSetting=function(){n.set(a.fullscreenEnabled),a.alerts.push({type:"success",title:"Configuration plein écran modifiée."})}}]),angular.module("mobileAngular").controller("ConnectionController",["$scope",function(a){a.offline=!1,a.$on("offline",function(){a.offline=!0}),a.$on("online",function(){a.offline=!1})}]),angular.module("mobileAngular").controller("EditEventController",["$scope","$http","$location","$routeParams","Mission","Event","Vehicle","Utils",function(a,b,c,d,e,f,g,h){e.get(parseInt(d.missionId)).then(function(b){a.mission=b,d.eventId?f.get(parseInt(d.eventId)).then(function(b){a.event=b}):(a.event={},a.event.start=h.getCurrentDateAndTime(),a.event.end=h.getCurrentDateAndTime(),a.event.missionId=a.mission.id)}),g.getAll().then(function(b){a.vehicles=b}),b.get("/resources/event-types.json").success(function(b){a.types=b}),a.back=function(){c.url("/mission/"+a.mission.id).search({page:"event"})},a.save=function(){f.save(a.event).then(function(){a.back()})}}]),angular.module("mobileAngular").controller("EventController",["$scope","$location","$window","$routeParams","Event",function(a,b,c,d,e){a.fetchEvents=function(){e.getByMissionId(d.missionId).then(function(b){a.events=b})},a.goToNewEvent=function(){b.url("/mission/"+d.missionId+"/events/new")},a.goToEditEvent=function(a){b.url("/mission/"+d.missionId+"/event/"+a+"/edit")},a.deleteModal=function(b){var d=c.confirm("Êtes vous sûr de vouloir supprimer l'évènement #"+b);d&&e.remove(b).then(function(){a.fetchEvents()})},a.fetchEvents()}]),angular.module("mobileAngular").controller("GesturesController",["$scope",function(a){a.tapMe=function(){console.log("Tapped")},a.swipeMeLeft=function(){console.log("swiped to the left"),a.swipeLeft=!0},a.swipeMeRight=function(){console.log("swiped to the right"),a.swipeRight=!0},a.end=function(){console.log("Transition end")},a.onThreshold=function(a){console.log("Threshold",a)},a.myFunction=function(){console.log("Fonction métier")},a.moveDraggable=function(){a.dragSwitch=!a.dragSwitch},a.moveDraggable2=function(){a.dragSwitch2=!a.dragSwitch2},a.moveDraggable3=function(){a.dragSwitch3=!a.dragSwitch3},a.releaseMe=function(){a.dragMessage="right"},a.holdMe=function(){a.hold=!a.hold},a.$watch("dragSwitch",function(a){console.log("watch drag",a)}),a.hold=!1,a.dragSwitch=!1,a.dragSwitch2=!1,a.dragSwitch3=!1}]),angular.module("mobileAngular").controller("MissionContainerController",["$scope","$routeParams","$http","$location","Mission","$window",function(a,b,c,d,e,f){a.getMission=function(){e.get(parseInt(b.missionId)).then(function(b){a.mission=b})},a.includeUrlIs=function(b){return a.includedUrl==b},a.toggleMenu=function(){a.menu=!a.menu},a.navigate=function(b){"back"==b?d.url("/"):(d.url("/mission/"+a.mission.id).search({page:b}),a.menu=!1)},a.getPathFromParams=function(){for(var b=d.search().page,c=0;c<a.menuItems.length;c++)if(a.menuItems[c].id==b)return a.menuItems[c].templateUrl;return""},a.showMenu=function(){a.includedUrl="",d.path("/mission/"+a.mission.id)},a.$on("$routeUpdate",function(){a.includedUrl=a.getPathFromParams(),f.scrollTo(0,0)}),a.$on("dataChanged",function(){a.getMission()}),c.get("/resources/mission-menu.json").success(function(b){a.menuItems=b,a.includedUrl=a.getPathFromParams()}),a.menu=!1,a.getMission()}]),angular.module("mobileAngular").controller("MissionsController",["$scope","Mission","$location","$window",function(a,b,c,d){b.getAll().then(function(b){a.missions=b}),a.$on("dataChanged",function(){b.getAll().then(function(b){a.missions=b})}),a.navigateTo=function(a){c.url("/mission/"+a.id).search({page:"mission"})},a.goToNewMission=function(){c.url("/mission/new")},a.deleteModal=function(c){var e=d.confirm("Êtes vous sûr de vouloir supprimer la mission #"+c);e&&b.notifyAndRemove(c).then(function(){b.getAll().then(function(b){a.missions=b})})}}]),angular.module("mobileAngular").controller("NewMissionController",["$scope","$location","Mission","Vehicle","Staff","Utils","Command",function(a,b,c,d,e,f){a.alerts=[],d.getAll().then(function(b){a.vehicles=b}),e.getAll().then(function(b){a.responsibles=b}),a.add=function(){if("1234"==a.password){var b=f.getCurrentDateAndTime();a.mission.created_at=b.date+" "+b.time,c.notifyAndSave(a.mission).then(function(){a.back()})}else a.alerts.push({type:"error",title:"Mauvais mot de passe",content:"Essayez 1234"})},a.back=function(){b.url("/")}}]),angular.module("mobileAngular").controller("NewStaffController",["$scope","$http","$location","$routeParams","Mission","Staff","Utils",function(a,b,c,d,e,f,g){a.staff={},a.staff.time=g.getCurrentDateAndTime(),e.get(parseInt(d.missionId)).then(function(b){a.mission=b}),f.getAll().then(function(b){a.persons=b}),b.get("/resources/functions.json").success(function(b){a.functions=b}),a.back=function(){c.url("/mission/"+d.missionId).search({page:"staff"})},a.add=function(){void 0===a.mission.staff&&(a.mission.staff=[]),a.mission.staff.push(a.staff),e.save(a.mission).then(function(){a.back()})}}]),angular.module("mobileAngular").controller("NewVehicleController",["$scope","$http","$location","$routeParams","Mission","Vehicle","Utils",function(a,b,c,d,e,f,g){e.get(parseInt(d.missionId)).then(function(b){a.mission=b}),f.getAll().then(function(b){a.vehicles=b}),b.get("/resources/vehicle-types.json").success(function(b){a.types=b,a.typeNames=[],a.types.forEach(function(b){a.typeNames.push(b.name)})}),a.back=function(){c.url("/mission/"+a.mission.id).search({page:"vehicle"})},a.add=function(){a.vehicle.store="vehicle",a.vehicle.time=g.getCurrentDateAndTime(),void 0===a.mission.vehicles&&(a.mission.vehicles=[]),a.mission.vehicles.push(a.vehicle),e.save(a.mission).then(function(){a.back()})}}]),angular.module("mobileAngular").controller("NotificationController",["$scope","$timeout","$location","$route","Command",function(a,b,c,d,e){a.hideArray=[],a.removeArray=[],a.toggleChange=function(){a.change=!0,b(function(){a.change=!1},500)},a.nb=0,a.notificationsVisible=!1,a.$on("dataChanged",function(){a.loadNewCommands()}),a.loadNewCommands=function(){a.hideArray=[],e.getNewCommands().then(function(b){a.commands=b,b.length>a.nb&&a.toggleChange(),a.nb=b.length})},a.loadNewCommands(),a.toggleNotifcations=function(){a.notificationsVisible=!a.notificationsVisible},a.hide=function(b,c){a.hideArray[c]=!0,b.status="read",e.save(b).then(function(){a.nb--})},a.clear=function(){for(var b=0;b<a.commands.length;b++){var c=a.commands[b];c.status="read",e.save(c).then(function(){a.loadNewCommands()})}},a.goToNotification=function(b){if(b.status="read",e.save(b).then(function(){a.loadNewCommands(),a.toggleNotifcations()}),"delete"==b.data.type)c.url("/");else{var f="/mission/"+b.data.id,g=c.path();f==g?d.reload():c.path(f).search({page:"mission"})}},a.goToDetails=function(){c.path("/commands/")},a.$on("$routeChangeStart",function(){a.notificationsVisible&&(a.notificationsVisible=!1)})}]),angular.module("mobileAngular").controller("StaffController",["$scope","$routeParams","$http","$window","$location","Mission","Staff",function(a,b,c,d,e,f,g){f.get(parseInt(b.missionId)).then(function(b){a.mission=b,a.refreshStaff()}),c.get("/resources/functions.json").success(function(b){a.functions=[],b.forEach(function(b){a.functions[b.id]=b.name})}),a.goToNewStaff=function(){e.url("/mission/"+a.mission.id+"/staff/new")},a.deleteModal=function(b){var c=d.confirm("Êtes vous sûr de vouloir supprimer la personne "+b.firstname+" "+b.lastname);if(c){var e=[];a.mission.staff.forEach(function(a){(a.id!=b.id||a.time.date!=b.time.date||a.time.time!=b.time.time)&&e.push(a)}),a.mission.staff=e,f.save(a.mission).then(function(){a.refreshStaff()})}},a.refreshStaff=function(){void 0!==a.mission.staff&&(a.staff=[],a.mission.staff.forEach(function(b){g.get(parseInt(b.id)).then(function(c){c.time=b.time,a.staff.push(c)})}))}}]),angular.module("mobileAngular").controller("UpdateMissionController",["$scope","$window","$routeParams","url","Mission","ImageStorage",function(a,b,c,d,e,f){a.$watch("mission",function(b){b&&b.image&&(console.log(b.image),f.getURL(b.image).then(function(b){console.log(b),a.imageUrl=b}))}),a.$watch("image",function(b){b&&(a.imageUrl=d.createObjectURL(b[0]))},!0),a.save=function(){if(void 0!==a.image&&a.image.length>0){var c=a.mission.image,d=a.image[0];c&&f.remove(c),console.log("saving image"),f.save(d.name,d),a.mission.image=d.name}e.notifyAndSave(a.mission).then(function(){a.alerts=[],a.alerts.push({type:"success",title:"Succès",content:"Mission mise à jour avec succès"}),b.scrollTo(0,0)})},a.print=function(){var b=a.mission,c=new jsPDF;c.setFont("helvetica"),c.setFontSize(22),c.text(10,20,"Mission "+b.id),c.line(10,25,200,25),c.setFontSize(16),c.text(10,35,"Raison : "+b.reason),c.text(10,45,"Type : "+b.type),c.setFontSize(22),c.text(10,65,"Appelant"),c.setFontSize(16),c.text(10,85,"Nom : "+b.caller.lastname),c.text(10,95,"Prénom : "+b.caller.firstname),c.text(10,105,"Téléphone : "+b.caller.phone),c.setFontSize(22),c.text(10,125,"Observation"),c.setFontSize(16);for(var d=0,e=145;d<b.observation.length;)c.text(10,e,b.observation.substring(d,d+70).trim()),d+=70,e+=10,e>=270&&(c.addPage(),e=20);c.save("test.pdf")}}]),angular.module("mobileAngular").controller("VehicleController",["$scope","$routeParams","$window","$location","Mission","Vehicle",function(a,b,c,d,e,f){e.get(parseInt(b.missionId)).then(function(b){a.mission=b,a.refreshVehicles()}),a.goToNewVehicle=function(){d.url("/mission/"+a.mission.id+"/vehicle/new")},a.deleteModal=function(b){var d=c.confirm("Êtes vous sûr de vouloir supprimer le véhicule #"+b.name);if(d){var f=[];a.mission.vehicles.forEach(function(a){(a.id!=b.id||a.time.date!=b.time.date||a.time.time!=b.time.time)&&f.push(a)}),a.mission.vehicles=f,e.save(a.mission).then(function(){a.refreshVehicles()})}},a.refreshVehicles=function(){void 0!==a.mission.vehicles&&(a.vehicles=[],a.mission.vehicles.forEach(function(b){f.get(parseInt(b.id)).then(function(c){c.time=b.time,a.vehicles.push(c)})}))}}]),angular.module("mobileAngular").directive("cube",function(){return{restrict:"E",templateUrl:"/partials/directives/cube.html",link:function(a,b){var c=[Hammer.DIRECTION_LEFT,Hammer.DIRECTION_RIGHT],d=b.find("#cube");Hammer(b[0]).on("drag",function(a){a.gesture.preventDefault();var b,e=a.gesture.direction;console.log(c.indexOf(e)),b=-1!=c.indexOf(e)?"Y":"X",d.css("transform","translateZ( -100px ) rotate"+b+"("+a.gesture.angle+"deg)")})}}}),angular.module("mobileAngular").directive("exit",function(){return{restrict:"A",template:'<span class="hidden-phone" ng-transclude></span><i class="icon-off icon-white"></i>',link:function(a,b){angular.element(b),b.bind("click",function(){screenfull.exit()})},transclude:!0}}),angular.module("mobileAngular").directive("fullscreenFocus",["$parse",function(a){return{restrict:"A",link:function(b,c,d){var e=$("#fullscreen-input-container"),f=e.children("textarea");c.bind("focus",function(){var c=a(d.ngModel);f.on("focus",function(){f.val(c(b)),f.off("focus")}),f.on("blur",function(){c.assign(b,f.val()),f.off("blur"),f.val(""),e.hide()}),e.show(),f.focus()})}}}]),angular.module("mobileAngular").directive("launch",["$location",function(a){return{restrict:"A",link:function(b,c){c.bind("click",function(){a.path("/"),screenfull.request()})}}}]),angular.module("mobileAngular").directive("loader",function(){return{restrict:"E",templateUrl:"/partials/directives/loader.html"}}),angular.module("mobileAngular").directive("ngDrag",["$parse",function(){return{restrict:"E",scope:{dragSwitch:"=switch",bound:"@",onThreshold:"&",bounded:"@",preventDefault:"@"},link:function(a,b,c){var d=b.parent(),e=!1;void 0===c["switch"]&&(e=a.dragSwitch);var f,g,h="X",i="dragright dragleft";c.axis&&"Y"==c.axis.toUpperCase()&&(h="Y",i="dragup dragdown"),a.isAbove=function(a,b){return 0>b?b>=a:a>=b},a.calculateDirection=function(a,b){return"Y"==h?a>b?"up":"down":b>a?"right":"left"},a.switch=function(b){void 0!==c["switch"]&&a.dragSwitch!=b&&(a.dragSwitch=b)},a.move=function(a,b){d.removeClass("animate"),b&&d.addClass("animate");var c;c="Y"==h?"0,"+a+"px, 0":a+"px, 0, 0",d.css("transform","translate3d("+c+")")},a.$watch("dragSwitch",function(b){e=b,e?a.move(a.bound,!0):a.move(0,!0)}),Hammer(d[0]).on(i,function(b){g=a.calculateDirection(f,b.gesture["delta"+h]),f=b.gesture["delta"+h],a.preventDefault&&b.gesture.preventDefault(),b.stopPropagation();var c=b.gesture["delta"+h];e&&(c+=parseInt(a.bound)),a.bounded&&a.isAbove(c,a.bound)&&(c=a.bound),a.move(c)}),Hammer(d[0]).on("dragend",function(){var b,c=a.bound;"Y"==h?(b=c>=0&&g!=Hammer.DIRECTION_UP,b=b||0>=c&&g!=Hammer.DIRECTION_DOWN):(b=c>=0&&g==Hammer.DIRECTION_RIGHT,b=b||0>=c&&g==Hammer.DIRECTION_LEFT),b?(e=!0,a.switch(!0),a.$apply(function(){a.onThreshold()}),a.move(a.bound,!0)):e?(e=!1,a.switch(!1),a.$apply(),a.move("0",!0)):a.move("0",!0)})}}}]),angular.module("mobileAngular").directive("ngFiles",function(){return{restrict:"A",scope:{files:"=ngModel"},link:function(a,b,c){if(void 0===c.ngModel)throw"ngFiles directive : ngModel attribute needed!";var d=angular.element(b);d.bind("change",function(){a.files=this.files,a.$apply()})}}}),angular.module("mobileAngular").directive("ngTap",function(){return function(a,b,c){var d;d=!1,b.bind("touchstart",function(){b.addClass("active"),d=!0}),b.bind("touchmove",function(){b.removeClass("active"),d=!1}),b.bind("touchend",function(){b.removeClass("active"),d&&a.$apply(c.ngTap,b)})}}),angular.module("mobileAngular").directive("onTransitionEnd",["$parse","transitionEndEvent",function(a,b){return{restrict:"A",link:function(c,d,e){var f=a(e.onTransitionEnd);d.bind(b,function(){c.$apply(function(){f(c)})})}}}]),angular.module("mobileAngular").directive("thumbnail",function(){return{restrict:"E",scope:{src:"@"},templateUrl:"/partials/directives/thumbnail.html",link:function(a,b){var c=$("#overlay"),d=$("#lightBox");0==c.length&&($("body").append("<div id='overlay'></div>"),c=$("#overlay")),0==d.length&&($("body").append("<div id='lightBox'><img /></div>"),d=$("#lightBox")),Hammer(c[0]).on("tap",function(){d.hide(),$(this).hide()});var e=$(b).find("img");Hammer(e[0]).on("tap",function(){var a=$(window).height(),b=$("#lightBox>img");b.css("max-height",(a-100).toString()+"px"),b.attr("src",$(this).attr("src")),b.load(function(){c.show(),d.show(),d.css({"margin-left":-(b.width()/2),"margin-top":-(b.height()/2)})})})}}}),angular.module("mobileAngular").filter("eventDestination",function(){return function(a){return"intervention"==a?"/partials/mission/events/address.html":"hospitalisation"==a?"/partials/mission/events/service.html":""}}),angular.module("mobileAngular").filter("missionDestination",function(){return function(a){if(void 0!==a)for(var b=0;b<a.length;b++)if("intervention"==a[b].type)return a[b].city}}),angular.module("mobileAngular").factory("Backend",["localStorage",function(a){var b="SMUR_BACKEND";return{get:function(){return a.getItem(b)},set:function(c){a.setItem(b,c)}}}]),angular.module("mobileAngular").factory("Command",["$q","$rootScope","$http","$timeout","ClientID","IDBService",function(a,b,c,d,e,f){var g={store:void 0,getStore:function(){var c=a.defer();return this.store?c.resolve(this.store):new IDBStore({dbVersion:2,storeName:"commands",keyPath:"id",autoIncrement:!0,onStoreReady:function(){var a=this;g.store=this,b.$apply(function(){c.resolve(a)})},indexes:[{name:"origin"},{name:"date"},{name:"status"}]}),c.promise}},h=f.getIDBCrudObject(g);return h.sendIfNeeded=function(c,d,f){Date.now();var h=a.defer();if("delete"==f){h.resolve();var i={entity:c.storeName,id:d,type:"delete"},j={};j.date=Date.now(),j.origin=e.get(),j.status="waiting",j.data=i,g.getStore().then(function(a){a.put(j)})}else c.get(d.id,function(a){b.$apply(h.resolve());var f=new Array;if(a)for(var i in d)d[i]!=a[i]&&f.push({attribute:i,new_val:d[i],old_val:a[i]});else for(var i in d)f.push({attribute:i,new_val:d[i],old_val:""});if(f.length>0){var j={entity:c.storeName,id:d.id,type:"update",changes:f},k={};k.date=Date.now(),k.origin=e.get(),k.status="waiting",k.data=j,g.getStore().then(function(a){a.put(k)})}});return h.promise},h.getNonSentCommands=function(){var c=a.defer();return g.getStore().then(function(a){var d=a.makeKeyRange({lower:"waiting",upper:"waiting"});a.query(function(a){b.$apply(function(){c.resolve(a)})},{index:"status",keyRange:d})}),c.promise},h.getNewCommands=function(){var c=a.defer();return g.getStore().then(function(a){var d=a.makeKeyRange({lower:"new",upper:"new"});a.query(function(a){b.$apply(function(){c.resolve(a)})},{index:"status",keyRange:d})}),c.promise},h.getAllSorted=function(){var c=a.defer();return g.getStore().then(function(a){a.query(function(a){b.$apply(function(){c.resolve(a)})},{index:"date",order:"DESC"})}),c.promise},h}]),angular.module("mobileAngular").service("CommandUtils",["StoreProvider","Command","$rootScope",function(a,b,c){return{handleCommand:function(d,e,f,g){d.status=g?g:"new",void 0===f&&(f=!0),b.save(d),localStorage.setItem("LAST_CMD",d.date);var h=d.data,i=h.entity,j=a.getStoreByName(i);if(!j)return console.log("Unknown entity"),e&&e(),void 0;var k=d.data.type;"delete"==k?j.remove(d.data.id).then(function(){f&&c.$broadcast("dataChanged"),e&&e()}):j.get(h.id).then(function(a){a||(a={},a.id=h.id);var b=h.changes;b.forEach(function(b){a[b.attribute]=b.new_val}),j.save(a).then(function(){f&&c.$broadcast("dataChanged"),e&&e()})})}}}]),angular.module("mobileAngular").factory("DeviceType",["$window",function(a){var b=a.innerWidth;return 768>b?"phone":1300>b?"tablet":"desktop"}]),angular.module("mobileAngular").factory("Event",["$q","$rootScope","IDBService",function(a,b,c){var d={store:void 0,getStore:function(){var c=a.defer();return this.store?c.resolve(this.store):new IDBStore({dbVersion:2,storeName:"event",keyPath:"id",autoIncrement:!0,onStoreReady:function(){d.store=this;var a=this;b.$apply(function(){c.resolve(a)})},indexes:[{name:"missionId"}]}),c.promise}},e=c.getIDBCrudObject(d);return e.getByMissionId=function(c){var e=parseInt(c),f=a.defer();return d.getStore().then(function(a){var c=a.makeKeyRange({lower:e,upper:e});a.query(function(a){b.$apply(function(){f.resolve(a)})},{index:"missionId",keyRange:c})}),f.promise},e}]),angular.module("mobileAngular").factory("FileSystem",["$q","$rootScope","$window","FileSystemUtils","persistentStorage","requestFileSystem",function(a,b,c,d,e,f){var g={getFileSystem:function(){var h=a.defer(),i=function(a){g.fileSystem=a,b.$apply(function(){h.resolve(a)})};return e?e.requestQuota(10485760,function(a){f(window.PERSISTENT,a,i,d.errorHandler)}):c.webkitStorageInfo?window.webkitStorageInfo.requestQuota(PERSISTENT,10485760,function(a){f(PERSISTENT,a,i,d.errorHandler)},function(a){console.log("Error",a)}):f?f(PERSISTENT,10485760,i,d.errorHandler):(console.log("No FS API"),b.$apply(function(){h.reject("Cannot use FS API")})),h.promise}};return g}]),angular.module("mobileAngular").factory("FileSystemUtils",function(){return{errorHandler:function(a){var b="";switch(a.code){case FileError.QUOTA_EXCEEDED_ERR:b="Quota exceeded";break;case FileError.NOT_FOUND_ERR:b="Not found";break;case FileError.SECURITY_ERR:b="Security issue";break;case FileError.INVALID_MODIFICATION_ERR:b="Invalid modification";break;case FileError.INVALID_STATE_ERR:b="Invalid state";break;default:b="Unknown Error"}console.log("Error: "+b),console.log(a)}}}),angular.module("mobileAngular").factory("FullscreenSetting",["localStorage",function(a){var b="FULLSCREEN";return{get:function(){return a.getItem(b)},set:function(c){a.setItem(b,c)}}}]),angular.module("mobileAngular").service("IDBService",["$q","$rootScope",function(a,b){return{getIDBCrudObject:function(c){return{getAll:function(){var d=a.defer();return c.getStore().then(function(a){a.getAll(function(a){b.$apply(function(){d.resolve(a)})})}),d.promise},get:function(d){var e=a.defer();return c.getStore().then(function(a){a.get(d,function(a){b.$apply(function(){e.resolve(a)})})}),e.promise},remove:function(d){var e=a.defer();return c.getStore().then(function(a){a.remove(d,function(){b.$apply(function(){e.resolve("Sucess")})})}),e.promise},save:function(d){void 0===d.id&&(d.id=Date.now());var e=a.defer();return c.getStore().then(function(a){a.put(d,function(){b.$apply(function(){e.resolve("Sucess")})})}),e.promise},clear:function(){var d=a.defer();return c.getStore().then(function(a){a.clear(function(){b.$apply(function(){d.resolve("Sucess")})})}),d.promise}}}}}]),angular.module("mobileAngular").factory("ImageStorage",["$q","$rootScope","FileSystem","FileSystemUtils","url",function(a,b,c,d,e){return{save:function(e,f){var g=a.defer();return c.getFileSystem().then(function(a){a.root.getFile(e,{create:!0},function(a){a.createWriter(function(a){a.onwriteend=function(){b.$apply(function(){g.resolve()})},a.onerror=function(a){console.log("Couldn't save image: "+a.toString())},a.write(f)},d.errorHandler)},d.errorHandler)}),g.promise},getURL:function(f){var g=a.defer();return c.getFileSystem().then(function(a){a.root.getFile(f,{},function(a){b.$apply(function(){console.log(a);var b;b=a.isFile&&a.file_&&a.file_.blob_?e.createObjectURL(a.file_.blob_):a.toURL(),g.resolve(b)})},d.errorHandler)}),g.promise},remove:function(a){c.getFileSystem().then(function(b){b.root.getFile(a,{create:!1},function(a){a.remove(function(){},d.errorHandler)},d.errorHandler)})}}}]),angular.module("mobileAngular").factory("Mission",["$q","$rootScope","SyncedResourceService",function(a,b,c){var d={store:void 0,getStore:function(){var c=a.defer();return this.store?c.resolve(this.store):new IDBStore({dbVersion:1,storeName:"mission",keyPath:"id",autoIncrement:!0,onStoreReady:function(){d.store=this;var a=this;b.$apply(function(){c.resolve(a)})}}),c.promise}};return c.syncedResourceManager(d)}]),angular.module("mobileAngular").factory("SocketService",["Backend",function(a){return io.connect(a.get())}]),angular.module("mobileAngular").factory("Staff",["$q","$rootScope","IDBService",function(a,b,c){var d={store:void 0,getStore:function(){var c=a.defer();return this.store?c.resolve(this.store):new IDBStore({dbVersion:2,storeName:"staff",keyPath:"id",autoIncrement:!0,onStoreReady:function(){d.store=this;var a=this;b.$apply(function(){c.resolve(a)})}}),c.promise}};return c.getIDBCrudObject(d)}]),angular.module("mobileAngular").service("StoreProvider",["Mission","Event","Vehicle","Staff",function(a,b,c,d){return{getStoreByName:function(e){return"mission"==e?a:"event"==e?b:"vehicle"==e?c:"person"==e?d:void 0}}}]),angular.module("mobileAngular").service("SyncedResourceService",["$q","$rootScope","IDBService","Command",function(a,b,c,d){return{syncedResourceManager:function(b){var e=c.getIDBCrudObject(b);return e.notifyAndRemove=function(c){var f=a.defer();return b.getStore().then(function(a){d.sendIfNeeded(a,c,"delete").then(function(){e.remove(c).then(function(){f.resolve()})})}),f.promise},e.notifyAndSave=function(c){var f=a.defer();return void 0===c.id&&(c.id=Date.now()),b.getStore().then(function(a){d.sendIfNeeded(a,c,"update").then(function(){e.save(c).then(function(){f.resolve()})})}),f.promise},e}}}]),angular.module("mobileAngular").value("url",window.URL||window.webkitURL),angular.module("mobileAngular").service("Utils",function(){return{getCurrentDateAndTime:function(){var a=new Date;return{date:a.getFullYear()+"-"+this.toTwoDigits(a.getMonth()+1)+"-"+this.toTwoDigits(a.getDate()),time:this.toTwoDigits(a.getHours())+":"+this.toTwoDigits(a.getMinutes())}},toTwoDigits:function(a){var b=a.toString();return 1==b.length&&(b="0"+b),b}}}),angular.module("mobileAngular").factory("Vehicle",["$q","$rootScope","IDBService",function(a,b,c){var d={store:void 0,getStore:function(){var c=a.defer();return this.store?c.resolve(this.store):new IDBStore({dbVersion:1,storeName:"vehicle",keyPath:"id",autoIncrement:!0,onStoreReady:function(){d.store=this;var a=this;b.$apply(function(){c.resolve(a)})}}),c.promise}};return c.getIDBCrudObject(d)}]),angular.module("mobileAngular").factory("ClientID",["localStorage",function(a){var b="SMUR_CLIENT_ID";return{get:function(){var c=a.getItem(b);return c?c:(this.set("temporaryClientId"),"temporaryClientId")},set:function(c){a.setItem(b,c)}}}]),angular.module("mobileAngular").value("localStorage",window.localStorage),angular.module("mobileAngular").value("persistentStorage",navigator.persistentStorage||navigator.webkitPersistentStorage),angular.module("mobileAngular").value("requestFileSystem",window.requestFileSystem||window.webkitRequestFileSystem),angular.module("mobileAngular").factory("transitionEndEvent",function(){var a,b,c=document.createElement("fakeelement"),d={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd",msTransition:"MSTransitionEnd",transition:"transitionend"};
for(a in d)void 0!==c.style[a]&&(b=d[a]);return c=null,b}),window.applicationCache.addEventListener("updateready",function(){window.applicationCache.status==window.applicationCache.UPDATEREADY&&(window.applicationCache.swapCache(),confirm("A new version of this application is available. Load it?")&&window.location.reload())}),angular.module("mobileAngular").run(["$rootScope","$location",function(a,b){var c="partials/init.html";a.boostraped=localStorage.getItem("SMUR_BOOSTRAPED"),a.$on("$routeChangeStart",function(d,e){console.log(e.templateUrl),a.boostraped?e.templateUrl==c&&b.path("/"):b.path("/init")})}]),angular.module("mobileAngular").run(["SocketService","$http","ClientID","CommandUtils","localStorage","Backend","$rootScope",function(a,b,c,d,e,f,g){var h=function(){var a=e.getItem("LAST_CMD"),c="";a&&(c='?{"date": {"$gt":'+a+'},"$sort": {"date": 1}}'),b.get(f.get()+"/commands"+c).success(function(a){var b=function(a,c){if(a>=c.length)return g.$broadcast("dataChanged"),void 0;var e=c[a];d.handleCommand(e,function(){b(++a,c)},!1)};b(0,a)})};a.on("commands:new",function(a){e.setItem("LAST_CMD",a.date);var b=c.get();console.log(a.origin,b),a.origin!=b&&d.handleCommand(a)}),a.on("error",function(){g.$broadcast("offline")}),a.on("disconnect",function(){g.$broadcast("offline")}),a.on("reconnect",function(){g.$broadcast("online")}),a.on("connect",h)}]),angular.module("mobileAngular").run(["$timeout","$http","Command","Backend",function(a,b,c,d){var e=5e3;a(function f(){c.getNonSentCommands().then(function(a){if(0!=a.length){var e=function(a,f){if(!(f>=a.length)){var g=a[f],h=JSON.parse(JSON.stringify(g));delete h.id,b.post(d.get()+"/commands",h).success(function(){g.status="sent",c.save(g).then(function(){e(a,++f)})})}};e(a,0)}}),a(f,e)},e)}]),angular.module("mobileAngular").run(["$rootScope","$location","DeviceType","FullscreenSetting",function(a,b,c,d){var e="false"===d.get();"desktop"==c||!screenfull.enabled||e?a.fullscreen=!0:screenfull.onchange=function(){a.fullscreen=screenfull.isFullscreen,a.$apply("fullscreen")},a.$on("$routeChangeStart",function(c,d){var e=d.templateUrl,f="partials/launch.html";a.fullscreen||e==f?a.fullscreen&&e==f&&b.path("/"):b.path("/launch")})}]),function(a){function b(b){var c,d,e=b.charAt(0).toUpperCase()+b.slice(1),f=["Moz","Webkit","O","ms"],g=document.createElement("div");if(b in g.style)d=b;else for(var h=0;h<f.length;h++)if(c=f[h]+e,c in g.style){d=c;break}return g=null,a.support[b]=d,d}if(!a.cssHooks)throw"jQuery 1.4.3+ is needed for this plugin to work";b("transform")}(jQuery);var benchmarking=!1,started=!1,results=[];document.addEventListener("fps",showFPS,!1),$(document).on("click","#bench-runner",function(){console.log("Starting benchmark"),goBackHome(),started||(FPSMeter.run(.5),started=!0,$("#fps-counter").show()),$("#fps-counter").css("background-color","red"),setTimeout(scenario,1e3)}),$(document).on("click","#toggle-counter",function(){console.log(started),started?(FPSMeter.stop(),started=!0,$("#fps-counter").hide()):(FPSMeter.run(.5),started=!0,$("#fps-counter").show())});