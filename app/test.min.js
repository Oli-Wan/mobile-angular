"use strict";var mobileAngular=angular.module("mobileAngular",["ngResource","$strap.directives","angular-gestures"]);mobileAngular.config(["$routeProvider",function(e){e.when("/",{templateUrl:"partials/missions.html",controller:"MissionsController"}),e.when("/mission/new",{templateUrl:"partials/missions/new.html",controller:"NewMissionController"}),e.when("/mission/:missionId",{templateUrl:"partials/mission-container.html",controller:"MissionContainerController",reloadOnSearch:!1}),e.when("/mission/:missionId/events/new",{templateUrl:"partials/mission/events/form.html",controller:"EditEventController"}),e.when("/mission/:missionId/event/:eventId/edit",{templateUrl:"partials/mission/events/form.html",controller:"EditEventController"}),e.when("/mission/:missionId/staff/new",{templateUrl:"partials/mission/staff/new.html",controller:"NewStaffController"}),e.when("/mission/:missionId/vehicle/new",{templateUrl:"partials/mission/vehicles/new.html",controller:"NewVehicleController"}),e.when("/storagemanagement",{templateUrl:"partials/misc/storage-management.html",controller:"StorageManagementController"}),e.when("/accelerometer",{templateUrl:"partials/misc/accelerometer.html",controller:"AccelerometerController"}),e.when("/gestures",{templateUrl:"partials/misc/gestures.html",controller:"GesturesController"}),e.when("/commands/",{templateUrl:"partials/misc/command-list.html",controller:"CommandController"}),e.when("/cube/",{templateUrl:"partials/misc/cube.html"}),e.otherwise({redirectTo:"/"})}]),mobileAngular.value("$strap.config",{datepicker:{format:"dd/mm/yyyy"}}),mobileAngular.run(["$rootScope","$window","$timeout",function(e,n){e.scrollX=n.scrollX,angular.element(n).bind("scroll",function(){e.scrollX=n.scrollX,e.$apply("scrollX")}),angular.element(n).bind("deviceorientation",function(n){e.orientationData=n,e.$apply("orientationData")}),screenfull.onchange=function(){e.fullscreen=screenfull.isFullscreen,e.$apply("fullScreen")}}]),mobileAngular.controller("AccelerometerController",function(e,n){n.$watch("orientationData",function(n){e.orientationData=n.originalEvent})}),mobileAngular.controller("BootstrapController",function(e,n,t,o,i,r,s,a,l,c,u,f){var d="SMUR_BOOSTRAPED";e.boostraped=i.getItem(d),e.progress=0,e.$watch("progress",function(n){n>=100&&(e.ready=!0)}),e.save=function(){e.progress=0,e.alerts=[],t.set(e.clientID),o.set(e.backend),e.progress+=10,n.get(e.backend+"/persons").success(function(n){var t=0;a.clear().then(function(){var o=function(n,t){var i=t[n],r={firstname:i.firstname,lastname:i.lastname,"function":{store:"function",id:i.function}};a.save(r).then(function(){n++,n<t.length?o(n,t):e.progress+=30})};o(t,n)})}).error(function(){e.alerts.push({type:"error",title:"Impossible de récupérer les données. Vérifiez que l'adresse du serveur est bonne et qu'il est lancé"})}),n.get(e.backend+"/vehicles").success(function(n){var t=0;s.clear().then(function(){var o=function(n,t){var i=t[n],r={name:i.name,type:i.type};s.save(r).then(function(){n++,n<t.length?o(n,t):e.progress+=30})};o(t,n)})}).error(function(){e.alerts.push({type:"error",title:"Impossible de récupérer les données. Vérifiez que l'adresse du serveur est bonne et qu'il est lancé"})}),n.get(e.backend+"/commands"+'?{"$sort": {"date": 1}}').success(function(n){if(n.length<=0)return e.progress=100,void 0;var t=30/n.length,o=function(n,i){if(n>=i.length)return e.progress=100,void 0;var r=i[n];f.handleCommand(r,function(){e.progress+=t,o(++n,i)},!1,"read")};o(0,n)})},e.continue=function(){i.setItem(d,!0),l.location.reload()}}),mobileAngular.controller("CommandController",function(e,n){e.commands=[],n.getAllSorted().then(function(n){console.log(n),e.commands=n})}),mobileAngular.controller("ConnectionController",function(e){e.offline=!1,e.$on("offline",function(){e.offline=!0}),e.$on("online",function(){e.offline=!1})}),mobileAngular.controller("EditEventController",function(e,n,t,o,i,r,s,a){i.get(parseInt(o.missionId)).then(function(n){e.mission=n,o.eventId?r.get(parseInt(o.eventId)).then(function(n){e.event=n}):(e.event={},e.event.start=a.getCurrentDateAndTime(),e.event.end=a.getCurrentDateAndTime(),e.event.missionId=e.mission.id)}),s.getAll().then(function(n){e.vehicles=n}),n.get("/resources/event-types.json").success(function(n){e.types=n}),e.back=function(){t.url("/mission/"+e.mission.id).search({page:"event"})},e.save=function(){r.save(e.event).then(function(){e.back()})}}),mobileAngular.controller("EventController",function(e,n,t,o,i){e.fetchEvents=function(){i.getByMissionId(o.missionId).then(function(n){e.events=n})},e.goToNewEvent=function(){n.url("/mission/"+o.missionId+"/events/new")},e.goToEditEvent=function(e){n.url("/mission/"+o.missionId+"/event/"+e+"/edit")},e.deleteModal=function(n){var o=t.confirm("Êtes vous sûr de vouloir supprimer l'évènement #"+n);o&&i.remove(n).then(function(){e.fetchEvents()})},e.fetchEvents()}),mobileAngular.controller("FullScreenController",function(e){screenfull.enabled&&(e.fullscreenSupport=!0),e.requestFullScreen=function(){screenfull.request()}}),mobileAngular.controller("GesturesController",function(e){e.tapMe=function(){console.log("Tapped")},e.swipeMeLeft=function(){console.log("swiped to the left"),e.swipeLeft=!0},e.swipeMeRight=function(){console.log("swiped to the right"),e.swipeRight=!0},e.end=function(){console.log("Transition end")},e.onThreshold=function(e){console.log("Threshold",e)},e.myFunction=function(){console.log("Fonction métier")},e.moveDraggable=function(){e.dragSwitch=!e.dragSwitch},e.moveDraggable2=function(){e.dragSwitch2=!e.dragSwitch2},e.moveDraggable3=function(){e.dragSwitch3=!e.dragSwitch3},e.releaseMe=function(){e.dragMessage="right"},e.holdMe=function(){e.hold=!e.hold},e.$watch("dragSwitch",function(e){console.log("watch drag",e)}),e.hold=!1,e.dragSwitch=!1,e.dragSwitch2=!1,e.dragSwitch3=!1}),mobileAngular.controller("MissionContainerController",function(e,n,t,o,i,r){e.getMission=function(){i.get(parseInt(n.missionId)).then(function(n){e.mission=n})},e.includeUrlIs=function(n){return e.includedUrl==n},e.toggleMenu=function(){e.menu=!e.menu},e.navigate=function(n){"back"==n?o.url("/"):(o.url("/mission/"+e.mission.id).search({page:n}),e.menu=!1)},e.getPathFromParams=function(){for(var n=o.search().page,t=0;t<e.menuItems.length;t++)if(e.menuItems[t].id==n)return e.menuItems[t].templateUrl;return""},e.showMenu=function(){e.includedUrl="",o.path("/mission/"+e.mission.id)},e.$on("$routeUpdate",function(){e.includedUrl=e.getPathFromParams(),r.scrollTo(0,0)}),e.$on("dataChanged",function(){e.getMission()}),t.get("/resources/mission-menu.json").success(function(n){e.menuItems=n,e.includedUrl=e.getPathFromParams()}),e.menu=!1,e.getMission()}),mobileAngular.controller("MissionsController",function(e,n,t,o){n.getAll().then(function(n){e.missions=n}),e.$on("dataChanged",function(){n.getAll().then(function(n){e.missions=n})}),e.navigateTo=function(e){t.url("/mission/"+e.id).search({page:"mission"})},e.goToNewMission=function(){t.url("/mission/new")},e.deleteModal=function(t){var i=o.confirm("Êtes vous sûr de vouloir supprimer la mission #"+t);i&&n.notifyAndRemove(t).then(function(){n.getAll().then(function(n){e.missions=n})})}}),mobileAngular.controller("NewMissionController",function(e,n,t,o,i,r){e.alerts=[],o.getAll().then(function(n){e.vehicles=n}),i.getAll().then(function(n){e.responsibles=n}),e.add=function(){if("1234"==e.password){var n=r.getCurrentDateAndTime();e.mission.created_at=n.date+" "+n.time,t.notifyAndSave(e.mission).then(function(){e.back()})}else e.alerts.push({type:"error",title:"Mauvais mot de passe",content:"Essayez 1234"})},e.back=function(){n.url("/")}}),mobileAngular.controller("NewStaffController",function(e,n,t,o,i,r,s){e.staff={},e.staff.time=s.getCurrentDateAndTime(),i.get(parseInt(o.missionId)).then(function(n){e.mission=n}),r.getAll().then(function(n){e.persons=n}),n.get("/resources/functions.json").success(function(n){e.functions=n}),e.back=function(){t.url("/mission/"+o.missionId).search({page:"staff"})},e.add=function(){void 0===e.mission.staff&&(e.mission.staff=[]),e.mission.staff.push(e.staff),i.save(e.mission).then(function(){e.back()})}}),mobileAngular.controller("NewVehicleController",function(e,n,t,o,i,r,s){i.get(parseInt(o.missionId)).then(function(n){e.mission=n}),r.getAll().then(function(n){e.vehicles=n}),n.get("/resources/vehicle-types.json").success(function(n){e.types=n,e.typeNames=[],e.types.forEach(function(n){e.typeNames.push(n.name)})}),e.back=function(){t.url("/mission/"+e.mission.id).search({page:"vehicle"})},e.add=function(){e.vehicle.store="vehicle",e.vehicle.time=s.getCurrentDateAndTime(),void 0===e.mission.vehicles&&(e.mission.vehicles=[]),e.mission.vehicles.push(e.vehicle),i.save(e.mission).then(function(){e.back()})}}),mobileAngular.controller("NotificationController",function(e,n,t,o,i){e.hideArray=[],e.removeArray=[],e.toggleChange=function(){e.change=!0,n(function(){e.change=!1},500)},e.nb=0,e.notificationsVisible=!1,e.$on("dataChanged",function(){e.loadNewCommands()}),e.loadNewCommands=function(){e.hideArray=[],i.getNewCommands().then(function(n){e.commands=n,n.length>e.nb&&e.toggleChange(),e.nb=n.length})},e.loadNewCommands(),e.toggleNotifcations=function(){e.notificationsVisible=!e.notificationsVisible},e.hide=function(n,t){e.hideArray[t]=!0,n.status="read",i.save(n).then(function(){e.nb--})},e.clear=function(){for(var n=0;n<e.commands.length;n++){var t=e.commands[n];t.status="read",i.save(t).then(function(){e.loadNewCommands()})}},e.goToNotification=function(n){if(n.status="read",i.save(n).then(function(){e.loadNewCommands(),e.toggleNotifcations()}),"delete"==n.data.type)t.url("/");else{var r="/mission/"+n.data.id,s=t.path();r==s?o.reload():t.path(r).search({page:"mission"})}},e.goToDetails=function(){t.path("/commands/")},e.$on("$routeChangeStart",function(){e.notificationsVisible&&(e.notificationsVisible=!1)})}),mobileAngular.controller("StaffController",function(e,n,t,o,i,r,s){r.get(parseInt(n.missionId)).then(function(n){e.mission=n,e.refreshStaff()}),t.get("/resources/functions.json").success(function(n){e.functions=[],n.forEach(function(n){e.functions[n.id]=n.name})}),e.goToNewStaff=function(){i.url("/mission/"+e.mission.id+"/staff/new")},e.deleteModal=function(n){var t=o.confirm("Êtes vous sûr de vouloir supprimer la personne "+n.firstname+" "+n.lastname);if(t){var i=[];e.mission.staff.forEach(function(e){(e.id!=n.id||e.time.date!=n.time.date||e.time.time!=n.time.time)&&i.push(e)}),e.mission.staff=i,r.save(e.mission).then(function(){e.refreshStaff()})}},e.refreshStaff=function(){void 0!==e.mission.staff&&(e.staff=[],e.mission.staff.forEach(function(n){s.get(parseInt(n.id)).then(function(t){t.time=n.time,e.staff.push(t)})}))}}),mobileAngular.controller("StorageManagementController",function(e,n,t,o,i,r,s,a,l,c,u,f,d){e.alerts=[],e.getStorageStats=function(){l?l.queryUsageAndQuota(function(n,t){e.fs={},e.fs.used=n,e.fs.total=t,e.fs.perc=100*(n/t)}):e.fsPolyfill=!0},e.getStorageStats(),e.clientId=f.get(),e.backend=d.get(),e.clearMission=function(){t.clear().then(function(){e.alerts.push({type:"success",title:"Mission cleared"})})},e.clearStaff=function(){o.clear().then(function(){e.alerts.push({type:"success",title:"Staff cleared"})})},e.clearEvent=function(){i.clear().then(function(){e.alerts.push({type:"success",title:"Event cleared"})})},e.clearVehicle=function(){r.clear().then(function(){e.alerts.push({type:"success",title:"Vehicle cleared"})})},e.clearCommand=function(){c.clear().then(function(){e.alerts.push({type:"success",title:"Command cleared"})})},e.populateStaff=function(){n.get(d.get()+"/persons").success(function(n){var t=0;o.clear().then(function(){var i=function(n,t){var r=t[n],s={firstname:r.firstname,lastname:r.lastname,"function":{store:"function",id:r.function}};o.save(s).then(function(){n++,n<t.length?i(n,t):e.alerts.push({type:"success",title:"Personnes ajoutées"})})};i(t,n)})})},e.populateVehicle=function(){n.get(d.get()+"/vehicles").success(function(n){var t=0;r.clear().then(function(){var o=function(n,t){var i=t[n],s={name:i.name,type:i.type};r.save(s).then(function(){n++,n<t.length?o(n,t):e.alerts.push({type:"success",title:"Véhicules ajoutés"})})};o(t,n)})})},e.clearFS=function(){s.getFileSystem().then(function(n){var t=n.root.createReader(),o=[],i=function(){t.readEntries(function(n){n.length?(o=o.concat(Array.prototype.slice.call(n||[],0)),o.forEach(function(n){n.isFile?n.remove(e.getStorageStats,a.errorHandler):n.removeRecursively(e.getStorageStats,a.errorHandler)})):listResults(o.sort())},a.errorHandler)};i()})},e.resetLastCmd=function(){u.setItem("LAST_CMD",0),e.alerts.push({type:"success",title:"ID de la dernière commande reçue remis à zéro."})},e.setClientId=function(){f.set(e.clientId),e.alerts.push({type:"success",title:"Client ID changé."})},e.setClientId=function(){d.set(e.backend),e.alerts.push({type:"success",title:"Backend changé."})}}),mobileAngular.controller("UpdateMissionController",function(e,n,t,o,i,r){e.$watch("mission",function(n){n&&n.image&&r.getURL(n.image).then(function(n){e.imageUrl=n})}),e.$watch("image",function(n){n&&(e.imageUrl=o.createObjectURL(n[0]))},!0),e.save=function(){if(void 0!==e.image&&e.image.length>0){var t=e.mission.image,o=e.image[0];t&&r.remove(t),r.save(o.name,o),e.mission.image=o.name}i.notifyAndSave(e.mission).then(function(){e.alerts=[],e.alerts.push({type:"success",title:"Succès",content:"Mission mise à jour avec succès"}),n.scrollTo(0,0)})}}),mobileAngular.controller("VehicleController",function(e,n,t,o,i,r){i.get(parseInt(n.missionId)).then(function(n){e.mission=n,e.refreshVehicles()}),e.goToNewVehicle=function(){o.url("/mission/"+e.mission.id+"/vehicle/new")},e.deleteModal=function(n){var o=t.confirm("Êtes vous sûr de vouloir supprimer le véhicule #"+n.name);if(o){var r=[];e.mission.vehicles.forEach(function(e){(e.id!=n.id||e.time.date!=n.time.date||e.time.time!=n.time.time)&&r.push(e)}),e.mission.vehicles=r,i.save(e.mission).then(function(){e.refreshVehicles()})}},e.refreshVehicles=function(){void 0!==e.mission.vehicles&&(e.vehicles=[],e.mission.vehicles.forEach(function(n){r.get(parseInt(n.id)).then(function(t){t.time=n.time,e.vehicles.push(t)})}))}}),mobileAngular.directive("cube",function(){return{restrict:"E",templateUrl:"/partials/directives/cube.html",link:function(e,n){var t=[Hammer.DIRECTION_LEFT,Hammer.DIRECTION_RIGHT],o=n.find("#cube");Hammer(n[0]).on("drag",function(e){e.gesture.preventDefault();var n,i=-e.gesture.angle,r=e.gesture.direction;console.log(t.indexOf(r)),-1!=t.indexOf(r)?(n="Y",i=e.gesture.deltaY):(n="X",i=e.gesture.deltaX),console.log(r,n),o.css("transform","translateZ( -100px ) rotate"+n+"("+e.gesture.angle+"deg)")})}}}),mobileAngular.directive("loader",function(){return{restrict:"E",templateUrl:"/partials/directives/loader.html"}}),mobileAngular.directive("ngDrag",function(){return{restrict:"E",scope:{dragSwitch:"=switch",bound:"@",onThreshold:"&",bounded:"@",preventDefault:"@"},link:function(e,n,t){var o=n.parent();e.thresholdExceeded=!1,void 0===t["switch"]&&(e.thresholdExceeded=e.dragSwitch),e.axis="X";var i="dragright dragleft";t.axis&&"Y"==t.axis.toUpperCase()&&(e.axis="Y",i="dragup dragdown"),void 0===e.bound&&(e.threshold=500),e.isAbove=function(e,n){return 0>n?n>=e:e>=n},e.isDeltaAboveBound=function(n){return e.bound<0?e.bound>=n:n>=e.bound},e.switch=function(n){void 0!==t["switch"]&&e.dragSwitch!=n&&(e.dragSwitch=n)},e.move=function(n,t){o.removeClass("animate"),t&&o.addClass("animate");var i;i="Y"==e.axis?"0,"+n+"px, 0":n+"px, 0, 0",o.css("transform","translate3d("+i+") scale3d(1,1,1)")},e.$watch("dragSwitch",function(n){e.thresholdExceeded=n,e.thresholdExceeded?e.move(e.bound,!0):e.move(0,!0)}),Hammer(o[0]).on(i,function(n){e.preventDefault&&n.gesture.preventDefault(),n.stopPropagation();var t=n.gesture["delta"+e.axis];e.thresholdExceeded&&(t+=parseInt(e.bound)),e.bounded&&e.isAbove(t,e.bound)&&(t=e.bound),e.move(t)}),Hammer(o[0]).on("release",function(n){e.preventDefault&&n.gesture.preventDefault(),$this=$(this);var t=n.gesture["delta"+e.axis];e.thresholdExceeded&&(t+=parseInt(e.bound)),e.isAbove(t,e.bound/2)?(e.thresholdExceeded=!0,e.switch(!0),e.$apply(function(){e.onThreshold()}),e.move(e.bound,!0)):e.thresholdExceeded?(e.thresholdExceeded=!1,e.switch(!1),e.$apply(),e.move("0",!0)):e.move("0",!0)})}}}),mobileAngular.directive("ngFiles",function(){return{restrict:"A",scope:{files:"=ngModel"},link:function(e,n,t){if(void 0===t.ngModel)throw"ngFiles directive : ngModel attribute needed!";var o=angular.element(n);o.bind("change",function(){e.files=this.files,e.$apply()})}}}),mobileAngular.directive("ngTap",function(){return function(e,n,t){var o;o=!1,n.bind("touchstart",function(){n.addClass("active"),o=!0}),n.bind("touchmove",function(){n.removeClass("active"),o=!1}),n.bind("touchend",function(){n.removeClass("active"),o&&e.$apply(t.ngTap,n)})}}),mobileAngular.directive("onTransitionEnd",function(e,n){return{restrict:"A",link:function(t,o,i){var r=e(i.onTransitionEnd);o.bind(n,function(e){console.log("transion-end",e),t.$apply(function(){r(t)})})}}}),mobileAngular.directive("thumbnail",function(){return{restrict:"E",scope:{src:"@"},templateUrl:"/partials/directives/thumbnail.html",link:function(e,n){var t=$("#overlay"),o=$("#lightBox");0==t.length&&($("body").append("<div id='overlay'></div>"),t=$("#overlay")),0==o.length&&($("body").append("<div id='lightBox'><img /></div>"),o=$("#lightBox")),Hammer(t[0]).on("tap",function(){o.hide(),$(this).hide()});var i=$(n).find("img");Hammer(i[0]).on("tap",function(){var e=$(window).height();$lightBoxImg=$("#lightBox>img"),$lightBoxImg.css("max-height",(e-100).toString()+"px"),$lightBoxImg.attr("src",$(this).attr("src")),$lightBoxImg.load(function(){t.show(),o.show(),o.css({"margin-left":-($lightBoxImg.width()/2),"margin-top":-($lightBoxImg.height()/2)})})})}}}),mobileAngular.filter("eventDestination",function(){return function(e){return"intervention"==e?"/partials/mission/events/address.html":"hospitalisation"==e?"/partials/mission/events/service.html":""}}),mobileAngular.filter("missionDestination",function(){return function(e){if(void 0!==e)for(var n=0;n<e.length;n++)if(e[n].type==intervention)return e[n].city}}),mobileAngular.factory("Backend",function(e){var n="SMUR_BACKEND";return{get:function(){return e.getItem(n)},set:function(t){e.setItem(n,t)}}}),mobileAngular.factory("ClientID",function(e){var n="SMUR_CLIENT_ID";return{get:function(){var t=e.getItem(n);return t?t:(this.set("temporaryClientId"),"temporaryClientId")},set:function(t){e.setItem(n,t)}}}),mobileAngular.factory("Command",function(e,n,t,o,i,r){var s={store:void 0,getStore:function(){var t=e.defer();return this.store?t.resolve(this.store):new IDBStore({dbVersion:2,storeName:"commands",keyPath:"id",autoIncrement:!0,onStoreReady:function(){var e=this;s.store=this,n.$apply(function(){t.resolve(e)})},indexes:[{name:"origin"},{name:"date"},{name:"status"}]}),t.promise}},a=r.getIDBCrudObject(s);return a.sendIfNeeded=function(t,o,r){Date.now();var a=e.defer();if("delete"==r){a.resolve();var l={entity:t.storeName,id:o,type:"delete"},c={};c.date=Date.now(),c.origin=i.get(),c.status="waiting",c.data=l,s.getStore().then(function(e){e.put(c)})}else t.get(o.id,function(e){n.$apply(a.resolve());var r=new Array;if(e)for(var l in o)o[l]!=e[l]&&r.push({attribute:l,new_val:o[l],old_val:e[l]});else for(var l in o)r.push({attribute:l,new_val:o[l],old_val:""});if(r.length>0){var c={entity:t.storeName,id:o.id,type:"update",changes:r},u={};u.date=Date.now(),u.origin=i.get(),u.status="waiting",u.data=c,s.getStore().then(function(e){e.put(u)})}});return a.promise},a.getNonSentCommands=function(){var t=e.defer();return s.getStore().then(function(e){var o=e.makeKeyRange({lower:"waiting",upper:"waiting"});e.query(function(e){n.$apply(function(){t.resolve(e)})},{index:"status",keyRange:o})}),t.promise},a.getNewCommands=function(){var t=e.defer();return s.getStore().then(function(e){var o=e.makeKeyRange({lower:"new",upper:"new"});e.query(function(e){n.$apply(function(){t.resolve(e)})},{index:"status",keyRange:o})}),t.promise},a.getAllSorted=function(){var t=e.defer();return s.getStore().then(function(e){e.query(function(e){n.$apply(function(){t.resolve(e)})},{index:"date",order:"DESC"})}),t.promise},a}),mobileAngular.service("CommandUtils",function(e,n,t){return{handleCommand:function(o,i,r,s){o.status=s?s:"new",void 0===r&&(r=!0),n.save(o),localStorage.setItem("LAST_CMD",o.date);var a=o.data,l=a.entity,c=e.getStoreByName(l);if(!c)return console.log("Unknown entity"),i&&i(),void 0;var u=o.data.type;"delete"==u?c.remove(o.data.id).then(function(){r&&t.$broadcast("dataChanged"),i&&i()}):c.get(a.id).then(function(e){e||(e={},e.id=a.id);var n=a.changes;n.forEach(function(n){e[n.attribute]=n.new_val}),c.save(e).then(function(){r&&t.$broadcast("dataChanged"),i&&i()})})}}}),mobileAngular.factory("Event",function(e,n,t){var o={store:void 0,getStore:function(){var t=e.defer();return this.store?t.resolve(this.store):new IDBStore({dbVersion:2,storeName:"event",keyPath:"id",autoIncrement:!0,onStoreReady:function(){o.store=this;var e=this;n.$apply(function(){t.resolve(e)})},indexes:[{name:"missionId"}]}),t.promise}},i=t.getIDBCrudObject(o);return i.getByMissionId=function(t){var i=parseInt(t),r=e.defer();return o.getStore().then(function(e){var t=e.makeKeyRange({lower:i,upper:i});e.query(function(e){n.$apply(function(){r.resolve(e)})},{index:"missionId",keyRange:t})}),r.promise},i}),mobileAngular.factory("FileSystem",function(e,n,t,o,i,r){var s={getFileSystem:function(){var a=e.defer(),l=function(e){s.fileSystem=e,n.$apply(function(){a.resolve(e)})};return i?i.requestQuota(10485760,function(e){r(window.PERSISTENT,e,l,o.errorHandler)}):t.webkitStorageInfo?window.webkitStorageInfo.requestQuota(PERSISTENT,10485760,function(e){r(PERSISTENT,e,l,o.errorHandler)},function(e){console.log("Error",e)}):r?r(PERSISTENT,10485760,l,o.errorHandler):n.$apply(function(){a.reject("Cannot use FS API")}),a.promise}};return s}),mobileAngular.factory("FileSystemUtils",function(){return{errorHandler:function(e){var n="";switch(e.code){case FileError.QUOTA_EXCEEDED_ERR:n="Quota exceeded";break;case FileError.NOT_FOUND_ERR:n="Not found";break;case FileError.SECURITY_ERR:n="Security issue";break;case FileError.INVALID_MODIFICATION_ERR:n="Invalid modification";break;case FileError.INVALID_STATE_ERR:n="Invalid state";break;default:n="Unknown Error"}console.log("Error: "+n),console.log(e)}}}),mobileAngular.service("IDBService",function(e,n){return{getIDBCrudObject:function(t){return{getAll:function(){var o=e.defer();return t.getStore().then(function(e){e.getAll(function(e){n.$apply(function(){o.resolve(e)})})}),o.promise},get:function(o){var i=e.defer();return t.getStore().then(function(e){e.get(o,function(e){n.$apply(function(){i.resolve(e)})})}),i.promise},remove:function(o){var i=e.defer();return t.getStore().then(function(e){e.remove(o,function(){n.$apply(function(){i.resolve("Sucess")})})}),i.promise},save:function(o){void 0===o.id&&(o.id=Date.now());var i=e.defer();return t.getStore().then(function(e){e.put(o,function(){n.$apply(function(){i.resolve("Sucess")})})}),i.promise},clear:function(){var o=e.defer();return t.getStore().then(function(e){e.clear(function(){n.$apply(function(){o.resolve("Sucess")})})}),o.promise}}}}}),mobileAngular.factory("ImageStorage",function(e,n,t,o){return{save:function(i,r){var s=e.defer();return t.getFileSystem().then(function(e){e.root.getFile(i,{create:!0},function(e){e.createWriter(function(e){e.onwriteend=function(){n.$apply(function(){s.resolve()})},e.onerror=function(e){console.log("Couldn't save image: "+e.toString())},e.write(r)},o.errorHandler)},o.errorHandler)}),s.promise},getURL:function(i){var r=e.defer();return t.getFileSystem().then(function(e){e.root.getFile(i,{},function(e){n.$apply(function(){r.resolve(e.toURL())})},o.errorHandler)}),r.promise},remove:function(e){t.getFileSystem().then(function(n){n.root.getFile(e,{create:!1},function(e){e.remove(function(){},o.errorHandler)},o.errorHandler)})}}}),mobileAngular.value("localStorage",window.localStorage),mobileAngular.factory("Mission",function(e,n,t){var o={store:void 0,getStore:function(){var t=e.defer();return this.store?t.resolve(this.store):new IDBStore({dbVersion:1,storeName:"mission",keyPath:"id",autoIncrement:!0,onStoreReady:function(){o.store=this;var e=this;n.$apply(function(){t.resolve(e)})}}),t.promise}};return t.syncedResourceManager(o)}),mobileAngular.value("persistentStorage",navigator.persistentStorage||navigator.webkitPersistentStorage),mobileAngular.value("requestFileSystem",window.requestFileSystem||window.webkitRequestFileSystem),mobileAngular.factory("SocketService",function(e){return io.connect(e.get())}),mobileAngular.factory("Staff",function(e,n,t){var o={store:void 0,getStore:function(){var t=e.defer();return this.store?t.resolve(this.store):new IDBStore({dbVersion:2,storeName:"staff",keyPath:"id",autoIncrement:!0,onStoreReady:function(){o.store=this;var e=this;n.$apply(function(){t.resolve(e)})}}),t.promise}};return t.getIDBCrudObject(o)}),mobileAngular.service("StoreProvider",function(e,n,t,o){return{getStoreByName:function(i){return"mission"==i?e:"event"==i?n:"vehicle"==i?t:"person"==i?o:void 0}}}),mobileAngular.service("SyncedResourceService",function(e,n,t,o){return{syncedResourceManager:function(n){var i=t.getIDBCrudObject(n);return i.notifyAndRemove=function(t){var r=e.defer();return n.getStore().then(function(e){o.sendIfNeeded(e,t,"delete").then(function(){i.remove(t).then(function(){r.resolve()})})}),r.promise},i.notifyAndSave=function(t){var r=e.defer();return void 0===t.id&&(t.id=Date.now()),n.getStore().then(function(e){o.sendIfNeeded(e,t,"update").then(function(){i.save(t).then(function(){r.resolve()})})}),r.promise},i}}}),mobileAngular.factory("transitionEndEvent",function(){var e,n,t=document.createElement("fakeelement"),o={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd",msTransition:"MSTransitionEnd",transition:"transitionend"};for(e in o)void 0!==t.style[e]&&(n=o[e]);return t=null,n}),mobileAngular.value("url",window.URL||window.webkitURL),mobileAngular.service("Utils",function(){return{getCurrentDateAndTime:function(){var e=new Date;return{date:e.getFullYear()+"-"+this.toTwoDigits(e.getMonth()+1)+"-"+this.toTwoDigits(e.getDate()),time:this.toTwoDigits(e.getHours())+":"+this.toTwoDigits(e.getMinutes())}},toTwoDigits:function(e){var n=e.toString();return 1==n.length&&(n="0"+n),n},dataURLToBlob:function(e){var n=";base64,";if(-1==e.indexOf(n)){var t=e.split(","),o=t[0].split(":")[1],i=t[1];return new Blob([i],{type:o})}for(var t=e.split(n),o=t[0].split(":")[1],i=window.atob(t[1]),r=i.length,s=new Uint8Array(r),a=0;r>a;++a)s[a]=i.charCodeAt(a);return new Blob([s],{type:o})}}}),mobileAngular.factory("Vehicle",function(e,n,t){var o={store:void 0,getStore:function(){var t=e.defer();return this.store?t.resolve(this.store):new IDBStore({dbVersion:1,storeName:"vehicle",keyPath:"id",autoIncrement:!0,onStoreReady:function(){o.store=this;var e=this;n.$apply(function(){t.resolve(e)})}}),t.promise}};return t.getIDBCrudObject(o)}),mobileAngular.run(function(e,n,t,o,i,r,s){var a=function(){var e=i.getItem("LAST_CMD"),t="";e&&(t='?{"date": {"$gt":'+e+'},"$sort": {"date": 1}}'),n.get(r.get()+"/commands"+t).success(function(e){var n=function(e,t){if(e>=t.length)return s.$broadcast("dataChanged"),void 0;var i=t[e];o.handleCommand(i,function(){n(++e,t)},!1)};n(0,e)})};e.on("commands:new",function(e){i.setItem("LAST_CMD",e.date);var n=t.get();console.log(e.origin,n),e.origin!=n&&o.handleCommand(e)}),e.on("error",function(){s.$broadcast("offline")}),e.on("disconnect",function(){s.$broadcast("offline")}),e.on("reconnect",function(){s.$broadcast("online")}),e.on("connect",a)}),mobileAngular.run(function(e,n,t,o){var i=5e3;e(function r(){t.getNonSentCommands().then(function(e){if(0!=e.length){var i=function(e,r){if(!(r>=e.length)){var s=e[r],a=JSON.parse(JSON.stringify(s));delete a.id,n.post(o.get()+"/commands",a).success(function(){s.status="sent",t.save(s).then(function(){i(e,++r)})})}};i(e,0)}}),e(r,i)},i)}),function(e){function n(n){var t,o,i=n.charAt(0).toUpperCase()+n.slice(1),r=["Moz","Webkit","O","ms"],s=document.createElement("div");if(n in s.style)o=n;else for(var a=0;a<r.length;a++)if(t=r[a]+i,t in s.style){o=t;break}return s=null,e.support[n]=o,o}if(!e.cssHooks)throw"jQuery 1.4.3+ is needed for this plugin to work";var t=n("transform");t&&"transform"!==t&&(e.cssHooks.transform={get:function(n){return e.css(n,t)},set:function(e,n){e.style[t]=n}})}(jQuery);